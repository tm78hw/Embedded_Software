#include <B31DGMonitor.h>


//Define Pin Names
#define TASK_1_DP 6
#define TASK_2_DP 7
#define TASK_3_DP 2
#define TASK_4_DP 1
#define TASK_4_LED 0

//Define delay constants For Task 1
int T1H = 200;    //Time 1 High in us
int T1L = 50;     //Time 1 Low in us
int T2H = 30;     //Time 2 High in us

int Task_1_Period = 4;    //Period of Task 1 in ms
int Task_2_Period = 20;   //Period of Task 2 in ms
int Task_3_Period = 8;    //Period of Task 3 in ms
int Task_4_Period = 20;   //Increment for signal A
int Task_5_Period = 100;  //Period of Task 5 in ms

int Task_2_TH = 0;
int Task_2_TL = 0;
int Task_3_TH = 0;
int Task_3_TL = 0;
int Task_2_Freq = 0;
int Task_3_Freq = 0;
float Task_2_Freq_Int = 0;
float Task_3_Freq_Int = 0;

float Task_4_R1 = 0;
float Task_4_R2 = 0;
float Task_4_R3 = 0;
float Task_4_R4 = 0;
float Task_4_Avg = 0;

int i = 0;

void B31DGCyclicExecutiveMonitor();


void setup(void) {
  pinMode(TASK_1_DP, OUTPUT);
  pinMode(TASK_2_DP, INPUT);
  pinMode(TASK_3_DP, INPUT);
  pinMode(TASK_4_DP, INPUT);
  pinMode(TASK_4_LED, OUTPUT);
  Serial.begin(9600);
  //monitor.startMonitoring();
}

void Task1() {
  //B31DGCyclicExecutiveMonitor.jobStarted(1);
  digitalWrite(TASK_1_DP, HIGH);   //TASK_1_DP is held high for duration T1H
  delayMicroseconds(T1H);
  digitalWrite(TASK_1_DP, LOW);    //Then Low for duration T1L
  delayMicroseconds(T1L);
  digitalWrite(TASK_1_DP, HIGH);   //Then high for duration T2H
  delayMicroseconds(T2H);
  digitalWrite(TASK_1_DP, LOW);
  //B31DGCyclicExecutiveMonitor.jobEnded(1);
}

void Task2() {
  //monitor.jobStarted(2);
  Task_2_TH = pulseIn(TASK_2_DP, HIGH);
  Task_2_TL = pulseIn(TASK_2_DP, LOW);
  Task_2_Freq = 1/(Task_2_TH+Task_2_TL);
  //monitor.jobEnded(2);
}

void Task3() {
  //monitor.jobStarted(3);
  Task_3_TH = pulseIn(TASK_3_DP, HIGH);
  Task_3_TL = pulseIn(TASK_3_DP, LOW);
  Task_3_Freq = 1/(Task_3_TH+Task_3_TL);
  //monitor.jobEnded(3);
}

void Task4() {
  //monitor.jobStarted(4);
  Task_4_R1 = analogRead(TASK_4_DP);
  Task_4_R2 = analogRead(TASK_4_DP);
  Task_4_R3 = analogRead(TASK_4_DP);
  Task_4_R4 = analogRead(TASK_4_DP);
  Task_4_Avg = (Task_4_R1 + Task_4_R1 + Task_4_R1 + Task_4_R1)/(4*4095/3.3);
  Serial.printf("Task_4_Avg = %f, \n", Task_4_Avg );
  
  if (Task_4_Avg >= 1.65){
    digitalWrite(TASK_4_LED, HIGH);
  }
  else{
    digitalWrite(TASK_4_LED, LOW);
  }
    
  //monitor.jobEnded(4);
}

void Task5() {
  //monitor.jobStarted(5);
  Task_2_Freq_Int = ((Task_2_Freq-333)/700)*99.99;
  Task_3_Freq_Int = ((Task_2_Freq-500)/700)*99.99;
  Serial.printf("Task 2 Frequnecy = %f, ", Task_2_Freq_Int );
  Serial.printf("Task 3 Frequency = %f, \n", Task_3_Freq_Int );
  //monitor.jobEnded(5);
}

void loop(void)
{
// implement your cyclic executive here
  for(i=1; i<=50; i++){          //for loop will run the sequence c number of times
  
  Task1();
  delayMicroseconds(744);

    if(i == 1||6||11||16||21||26||31||36||41|46){
      Task2();
    }
  delayMicroseconds(744); 
 
    if(i % 2 == 1){
      Task3();
    }
  delayMicroseconds(744);

    if(i == 1||6||11||16||21||26||31||36||41|46){
      Task4();
    }
  delayMicroseconds(744);

    if(i == 25||50){
      Task5();
    }
  delayMicroseconds(744);
        
  }

}
